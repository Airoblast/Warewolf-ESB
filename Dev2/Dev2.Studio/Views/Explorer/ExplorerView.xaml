<UserControl x:Class="Dev2.Studio.Views.Explorer.ExplorerView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:ap="clr-namespace:Dev2.Studio.AppResources.AttachedProperties"
             xmlns:NavigationViews="clr-namespace:Dev2.Studio.Views.Navigation"         
             xmlns:i="clr-namespace:System.Windows.Interactivity;assembly=System.Windows.Interactivity"                     
             xmlns:local="clr-namespace:Dev2.Studio.AppResources.Behaviors" 
             xmlns:Dev2="clr-namespace:Dev2.UI"
             xmlns:navigation="clr-namespace:Dev2.Studio.ViewModels.Navigation"
    xmlns:customControls2="clr-namespace:Dev2.CustomControls;assembly=Dev2.CustomControls"
    Name="Explorer">
    <Grid>
        <Grid.Resources>
            <Style TargetType="{x:Type TextBox}" x:Key="TreeViewTextBoxStyle">
                <Setter Property="Foreground" Value="{DynamicResource {x:Static SystemColors.ControlTextBrushKey}}"/>
                <Setter Property="Padding" Value="1"/>
                <Setter Property="AllowDrop" Value="true"/>
                <Setter Property="FocusVisualStyle" Value="{x:Null}"/>
                <Setter Property="ScrollViewer.PanningMode" Value="VerticalFirst"/>
                <Setter Property="Stylus.IsFlicksEnabled" Value="False"/>
                <Setter Property="Template">
                    <Setter.Value>
                        <ControlTemplate TargetType="{x:Type TextBox}">
                            <ScrollViewer x:Name="PART_ContentHost" SnapsToDevicePixels="{TemplateBinding SnapsToDevicePixels}" Template="{DynamicResource ScrollViewerControlTemplate1}"/>
                        </ControlTemplate>
                    </Setter.Value>
                </Setter>
                <Style.Triggers>
                    <MultiTrigger>
                        <MultiTrigger.Conditions>
                            <Condition Property="IsInactiveSelectionHighlightEnabled" Value="true"/>
                            <Condition Property="IsSelectionActive" Value="false"/>
                        </MultiTrigger.Conditions>
                        <Setter Property="SelectionBrush" Value="{DynamicResource {x:Static SystemColors.InactiveSelectionHighlightBrushKey}}"/>
                    </MultiTrigger>
                </Style.Triggers>
            </Style>
            <ControlTemplate x:Key="ScrollViewerControlTemplate1" TargetType="{x:Type ScrollViewer}">
                <Grid x:Name="Grid" Background="{TemplateBinding Background}">
                    <ScrollContentPresenter x:Name="PART_ScrollContentPresenter" CanContentScroll="{TemplateBinding CanContentScroll}" CanHorizontallyScroll="False" CanVerticallyScroll="False" ContentTemplate="{TemplateBinding ContentTemplate}" Content="{TemplateBinding Content}" Grid.Column="0" Margin="{TemplateBinding Padding}" Grid.Row="0"/>
                </Grid>
            </ControlTemplate>
        </Grid.Resources>
        <Grid.ColumnDefinitions>
            <ColumnDefinition />
            <ColumnDefinition Width="30"/>
        </Grid.ColumnDefinitions>
        <Grid.RowDefinitions>
            <RowDefinition  Height="Auto"/>
            <RowDefinition />
        </Grid.RowDefinitions>


            <Dev2:ConnectControl Grid.ColumnSpan="2" Margin="5"
                                 LabelText="Connect:" 
                                 Context="{Binding Context}"
                                 EnvironmentChangedCommand="{Binding EnvironmentChangedCommand}"
                                 EditButtonAutomationID="UI_ExplorerEditBtn_AutoID"
                                 NewButtonAutomationID="UI_ExplorerNewBtn_AutoID"
                                 ServerComboBoxAutomationID="UI_ExplorerServerCbx_AutoID"/>

        <NavigationViews:NavigationView x:Name="TheNavigationView" DataContext="{Binding NavigationViewModel}" Grid.Row="1" Grid.ColumnSpan="2">
            <NavigationViews:NavigationView.ItemContainerStyle>
                <Style TargetType="{x:Type TreeViewItem}">
                    <!--<EventSetter Event="TreeViewItem.DragOver" Handler="treeView_DragOver" />
                    <EventSetter Event="TreeViewItem.Drop" Handler="treeView_Drop" />
                    <EventSetter Event="TreeViewItem.MouseMove" Handler="treeView_MouseMove" />
                    <EventSetter Event="TreeViewItem.PreviewMouseDown" Handler="treeView_MouseDown" />-->
                    <Setter Property="Visibility" Value="{Binding IsFiltered, Converter={StaticResource BoolToVisibilityConverterNegative}, Mode=OneWay}" />
                    <Setter Property="IsExpanded" Value="{Binding IsExpanded, Mode=TwoWay}" />
                    <Setter Property="IsSelected" Value="{Binding IsSelected, Mode=TwoWay}" />
                    <Setter Property="Background" Value="White" />
                    <Setter Property="FontWeight" Value="Normal" />
                    <Setter Property="AutomationProperties.AutomationId" Value="{Binding Path=DataContext.DisplayName,RelativeSource={RelativeSource Self},Converter={StaticResource StringToAutomationIdConverter}}"/>
                    <Style.Triggers>
                        <Trigger Property="IsSelected" Value="True">
                            <Setter Property="FontWeight" Value="Bold" />
                        </Trigger>
                        <Trigger Property="IsEnabled" Value="False">
                            <Setter Property="FontWeight" Value="UltraLight" />
                        </Trigger>
                    </Style.Triggers>
                </Style>
            </NavigationViews:NavigationView.ItemContainerStyle>
            <NavigationViews:NavigationView.ItemTemplate>
                <HierarchicalDataTemplate DataType="{x:Type navigation:AbstractTreeViewModel}" ItemsSource="{Binding Path=Children}">

                    <Border IsHitTestVisible="True">
                        <Border.ContextMenu>
                            <ContextMenu Visibility="{Binding HasExecutableCommands, Converter={StaticResource BoolToVisConverter}}">
                                <ContextMenu.Resources>
                                    <Style TargetType="{x:Type MenuItem}">
                                        <Setter Property="HorizontalContentAlignment" Value="Left"/>
                                        <Setter Property="VerticalContentAlignment" Value="Center"/>
                                        <Setter Property="AutomationProperties.AutomationId" Value="UI_ExplorerContextMenu_AutoID" />
                                    </Style>
                                </ContextMenu.Resources>
                    
                                <MenuItem Header="Connect" Command="{Binding ConnectCommand}" Visibility="{Binding CanConnect, Converter={StaticResource BoolToVisConverter}}" />
                                <MenuItem Header="Disconnect" Command="{Binding DisconnectCommand}" Visibility="{Binding CanDisconnect, Converter={StaticResource BoolToVisConverter}}" AutomationProperties.AutomationId="UI_ExplorerContextMenuDisconnectItem_AutoID" />
                                <MenuItem Header="Refresh" Command="{Binding RefreshCommand}" Visibility="{Binding CanRefresh, Converter={StaticResource BoolToVisConverter}}" AutomationProperties.AutomationId="UI_ExplorerContextMenuRefreshItem_AutoID" />
                                <MenuItem Header="{Binding NewWorkflowTitle}" Command="{Binding Path=NewResourceCommand}" CommandParameter="Workflow" AutomationProperties.AutomationId="UI_RibbonApplicationMenu_New" >
                                 <MenuItem.Visibility>
                                        <MultiBinding Converter="{StaticResource MultipleBoolToVisibilityValueConverter}">
                                            <Binding Path="HasFileMenu"/>
                                            <Binding Path="HasNewWorkflowMenu"/>
                                        </MultiBinding>
                                    </MenuItem.Visibility>
                                </MenuItem>
                                <MenuItem Header="{Binding NewServiceTitle}" Visibility="{Binding HasNewServiceMenu, Converter={StaticResource BoolToVisConverter}}" >
                                    <MenuItem Header="Database Procedure Ctrl + Shift + D" Command="{Binding Path=NewResourceCommand}" CommandParameter="DbService"></MenuItem>
                                    <MenuItem Header="Plugin Ctrl + Shift + P" Command="{Binding Path=NewResourceCommand}" CommandParameter="PluginService"></MenuItem>
                                    <MenuItem Header="Web Ctrl + Shift + W" Command="{Binding Path=NewResourceCommand}" CommandParameter="WebService"></MenuItem>
                                </MenuItem>
                                <MenuItem Header="{Binding AddSourceTitle}" Visibility="{Binding HasNewSourceMenu, Converter={StaticResource BoolToVisConverter}}" >
                                    <MenuItem Header="Remote Warewolf" Command="{Binding Path=NewResourceCommand}" CommandParameter="RemoteWarewolf"></MenuItem>
                                    <MenuItem Header="Database" Command="{Binding Path=NewResourceCommand}" CommandParameter="DbSource"></MenuItem>
                                    <MenuItem Header="Plugin" Command="{Binding Path=NewResourceCommand}" CommandParameter="PluginSource"></MenuItem>
                                    <MenuItem Header="Web" Command="{Binding Path=NewResourceCommand}" CommandParameter="WebSource"></MenuItem>
                                    <MenuItem Header="Email" Command="{Binding Path=NewResourceCommand}" CommandParameter="EmailSource"></MenuItem>
                                </MenuItem>
                                <MenuItem Header="Open" Command="{Binding EditCommand}" Visibility="{Binding CanEdit, Converter={StaticResource BoolToVisConverter}}" />
                                <Separator Visibility="{Binding HasFileMenu, Converter={StaticResource BoolToVisConverter}}" />
                                <MenuItem Header="New Database Procedure Service   (Ctrl+Shift+D)" Visibility="{Binding HasFileMenu, Converter={StaticResource BoolToVisConverter}}" 
                                          Command="{Binding Path=NewResourceCommand}"
                                             CommandParameter="DatabaseService"/>
                                <MenuItem Header="New Plugin Service   (Ctrl+Shift+P)" Visibility="{Binding HasFileMenu, Converter={StaticResource BoolToVisConverter}}" 
                                          Command="{Binding Path=NewResourceCommand}"
                                             CommandParameter="ResourceService"/>
                                <MenuItem Header="New Web Service   (Ctrl+Shift+W)" Visibility="{Binding HasFileMenu, Converter={StaticResource BoolToVisConverter}}" 
                                          Command="{Binding Path=NewResourceCommand}"
                                             CommandParameter="WebService"/>
                                <Separator Visibility="{Binding HasFileMenu, Converter={StaticResource BoolToVisConverter}}" />
                                <MenuItem Header="New Remote Warewolf Source" Visibility="{Binding HasFileMenu, Converter={StaticResource BoolToVisConverter}}"
                                          Command="{Binding Path=NewResourceCommand}"
                                             CommandParameter="Server"/>
                                <MenuItem Header="New Database Source" Visibility="{Binding HasFileMenu, Converter={StaticResource BoolToVisConverter}}"
                                          Command="{Binding Path=NewResourceCommand}"
                                             CommandParameter="DbSource"/>
                                <MenuItem Header="New Plugin Source" Visibility="{Binding HasFileMenu, Converter={StaticResource BoolToVisConverter}}"
                                          Command="{Binding Path=NewResourceCommand}"
                                             CommandParameter="ResourceSource"/>
                                <MenuItem Header="New Web Source" Visibility="{Binding HasFileMenu, Converter={StaticResource BoolToVisConverter}}"
                                          Command="{Binding Path=NewResourceCommand}"
                                             CommandParameter="WebSource"/>
                                <MenuItem Header="New Email Source" Visibility="{Binding HasFileMenu, Converter={StaticResource BoolToVisConverter}}"
                                          Command="{Binding Path=NewResourceCommand}"
                                             CommandParameter="EmailSource"/>
                                <Separator Visibility="{Binding HasFileMenu, Converter={StaticResource BoolToVisConverter}}" />
                                <MenuItem Header="Build" Command="{Binding BuildCommand}" Visibility="{Binding CanBuild, Converter={StaticResource BoolToVisConverter}}" />
                                <MenuItem Header="{Binding DeployTitle}" Command="{Binding DeployCommand}" Visibility="{Binding CanDeploy, Converter={StaticResource BoolToVisConverter}}" />
                                <!--<MenuItem Header="Duplicate" Command="{Binding DuplicateCommand}" Visibility="{Binding CanDuplicate, Converter={StaticResource BoolToVisConverter}}" />-->
                                <MenuItem Header="Rename Folder   F2" Command="{Binding RenameCommand}" Visibility="{Binding CanRename, Converter={StaticResource BoolToVisConverter}}" />
                                <!--<MenuItem Header="Move/Rename" Command="{Binding MoveRenameCommand}" Visibility="{Binding CanMoveRename, Converter={StaticResource BoolToVisConverter}}" />-->
                                <MenuItem Header="Delete" Command="{Binding DeleteCommand}" Visibility="{Binding CanDelete, Converter={StaticResource BoolToVisConverter}}" />
                                <MenuItem Header="Remove" Command="{Binding RemoveCommand}" Visibility="{Binding CanRemove, Converter={StaticResource BoolToVisConverter}}" />
                                <!--<MenuItem Header="Show Dependencies" Command="{Binding ShowDependenciesCommand}" Visibility="{Binding CanShowDependencies, Converter={StaticResource BoolToVisConverter}}" />-->
                                <MenuItem Header="Debug" Command="{Binding DebugCommand}" Visibility="{Binding CanDebug, Converter={StaticResource BoolToVisConverter}}" />
                                <MenuItem Header="Run" Command="{Binding RunCommand}" Visibility="{Binding CanRun, Converter={StaticResource BoolToVisConverter}}" />
                                <!--<MenuItem Header="Manual Edit" Command="{Binding ManualEditCommand}" Visibility="{Binding CanManualEdit, Converter={StaticResource BoolToVisConverter}}" />-->
                                <MenuItem Header="Create Wizard" Command="{Binding CreateWizardCommand}" Visibility="{Binding CanCreateWizard, Converter={StaticResource BoolToVisConverter}}" />
                                <MenuItem Header="Edit Wizard" Command="{Binding EditWizardCommand}" Visibility="{Binding CanEditWizard, Converter={StaticResource BoolToVisConverter}}" />
                                <MenuItem Header="Help" Command="{Binding HelpCommand}" Visibility="{Binding CanHelp, Converter={StaticResource BoolToVisConverter}}" />

                                <MenuItem Header="Properties" Command="{Binding ShowPropertiesCommand}" Visibility="{Binding CanShowProperties, Converter={StaticResource BoolToVisConverter}}" />
                            </ContextMenu>
                        </Border.ContextMenu>
                        <StackPanel Orientation="Horizontal" AllowDrop="False">                       
                            <i:Interaction.Behaviors>
                                <local:NavigationItemViewModelMouseDownBehavior SetActiveEnvironmentOnClick="True" OpenOnDoubleClick="True" SelectOnClick="True" DontAllowDoubleClick="{Binding RelativeSource={RelativeSource FindAncestor,AncestorType=NavigationViews:NavigationView},Path=DataContext.IsFromActivityDrop}" />
                                <local:NavigationItemViewModelDragDropBehavior DontAllowDraging="{Binding RelativeSource={RelativeSource FindAncestor,AncestorType=NavigationViews:NavigationView},Path=DataContext.IsFromActivityDrop}" />
                            </i:Interaction.Behaviors>
                            <TextBlock Width="3"/>
                            <customControls2:CircularProgressBar Width="24" Height="24" Margin="0,1,0,1"
                                                    Visibility="{Binding IsRefreshing, Converter={StaticResource BoolToVisibilityConverterPositive}}"
                                                    AutomationProperties.AutomationId="UI_IndicatorRefresh_AutoID"/>                            
                            <Image Width="24" Height="24" Margin="0,1,0,1"
                                    Visibility="{Binding IsRefreshing, Converter={StaticResource BoolToVisibilityConverterNegative}}">
                                <i:Interaction.Triggers>
                                    <i:EventTrigger EventName="PreviewMouseDown">
                                        <i:InvokeCommandAction Command="{Binding RefreshCommand}"></i:InvokeCommandAction>
                                    </i:EventTrigger>
                                </i:Interaction.Triggers>                                
                                <Image.Source>
                                    <MultiBinding Converter="{StaticResource NavigationViewModelToImageConverter}">
                                        <MultiBinding.Bindings>
                                            <Binding Path="IconPath"/>
                                            <Binding Path="."/>
                                        </MultiBinding.Bindings>
                                    </MultiBinding>
                                </Image.Source>
                            </Image>
                            <ContentControl Content="{Binding}">
                                <ContentControl.Resources>
                                    <DataTemplate DataType="{x:Type navigation:ResourceTreeViewModel}">
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock Text="{Binding DisplayName}" Padding="3,0,0,0" Foreground="{Binding IsConnected, Converter={StaticResource BoolToDisabledFontColorConverter}}" />
                                        </StackPanel>
                                    </DataTemplate>
                                    <DataTemplate DataType="{x:Type navigation:AbstractTreeViewModel}">
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock Text="{Binding DisplayName, Mode=OneWay}" Padding="3,0,0,0" Foreground="{Binding IsConnected, Converter={StaticResource BoolToDisabledFontColorConverter}}" Visibility="{Binding IsRenaming, Converter={StaticResource BoolToVisibilityConverterNegative}}" />
                                            <TextBox Text="{Binding DisplayName, Mode=OneWay}" Padding="3,0,0,0" Foreground="{Binding IsConnected, Converter={StaticResource BoolToDisabledFontColorConverter}}" Visibility="{Binding IsRenaming, Converter={StaticResource BoolToVisibilityConverterPositive}}" />
                                            <TextBlock Text=" (" Visibility="{Binding ChildrenCount, Converter={StaticResource IntToVisibilityConverter}}"/>
                                            <TextBlock Text="{Binding ChildrenCount, Mode=OneWay}" Visibility="{Binding ChildrenCount, Converter={StaticResource IntToVisibilityConverter}}"/>
                                            <TextBlock Text=")" Visibility="{Binding ChildrenCount, Converter={StaticResource IntToVisibilityConverter}}"/>
                                        </StackPanel>
                                    </DataTemplate>
                                </ContentControl.Resources>
                            </ContentControl>
                        </StackPanel>
                    </Border>
                </HierarchicalDataTemplate>

            </NavigationViews:NavigationView.ItemTemplate>           
        </NavigationViews:NavigationView>
    </Grid>
</UserControl>
